<html>
<head>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="concepts/aaa7.js"></script>
<script src="concepts/inspire4.js"></script>
<script src="concepts/xerleben2.js"></script>
<script src="concepts/xplanung5_0.js"></script>
<style>

.loading { margin: auto; }

.loading span {
  line-height: 32px;
  margin-left: 12px;
  font-size: 16px;
  vertical-align: middle;
}

.loading img { vertical-align: middle; }

.loading_wrp {
  background-color: #FFF;
  display: block;
  height: 100%;
  left: 0;
  opacity: 0.5;
  filter: alpha(opacity=50);
  position: absolute;
  top: 0;
  width: 100%;
  z-index: 1020;
}

.loading_wrp .x16 span {
  line-height: 16px;
  font-size: 12px;
  margin-left: 6px;
}

.loading_wrp .x32 img {
  width: 32px;
  height: 32px;
}
</style>
<script>
function saveTextAsFile(tosave,fileext,filename)
{
    var a = document.createElement('a');
    a.style = "display: none";  
    var blob= new Blob([tosave], {type:'text/plain'});
    var url = window.URL.createObjectURL(blob);
    var filename = filename+fileext;
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
    }, 1000);
}
var filedata={}
function analyzeFile(){
	    var data = new FormData(); // das ist unser Daten-Objekt ...
	    data.append('file', document.getElementById('files').files[0]); // ... an die wir unsere Datei anhängen
	    data.append('fileformat',document.getElementById('fileformat').value)
	    $('#loading').show();
	    $.ajax({
	       url: 'rest/service/analyzeFile', // Wohin soll die Datei geschickt werden?
	       data: data,          // Das ist unser Datenobjekt.
	       type: 'POST',         // HTTP-Methode, hier: POST
	       processData: false,
	       contentType: false,
	       // und wenn alles erfolgreich verlaufen ist, schreibe eine Meldung
	       // in das Response-Div
	       success: function(data) { 
	    	   console.log(data)
	    	    var json=data;
	    	    var table="<tr><th>Dataset Column</th><th>Column URI</th><th>Column Range</th><th>Value SPARQL Query</th><th>Regular Expression (Optional)</th></tr>"
	    	    var i=0;
	    	    for(key in json["properties"]){
	    	    	if(json["properties"][i]!="the_geom"){
	    	    		table+="<tr><td id=\"datasetcol_"+i+"\" style=\"color:red\">"+json["properties"][i]+"</td>"
	    	    		table+="<td id=\"coluri_"+i+"\">"
	    	    		table+='<div class="ui-widget"><input id="coluri_'+i+'_input" name='+i+'></div>'//"<input type=\"text\" id=\"coluri_"+i+"_input\" name="+i+">
	    	    		table+="TripleStore:<select id=\"triplestoredropdown_property_"+i+"\"><option value=\"https://www.wikidata.org/w/api.php?action=wbsearchentities&&format=json&language=en&uselang=en&type=property&search=\">Wikidata</option></select></td>"
	    	    		table+="<td id=\"colrange_"+i+"\"><input type=\"text\" id=\"colrange_"+i+"_input\"></td>"
	    	    		table+="<td id=\"valuesparql_"+i+"\"></td>"
	    	    		table+="<td id=\"valueregex_"+i+"\"><input type=\"text\" id=\"colrange_"+i+"_input\"></td></tr>"
	    	    	}
	    	    	i++;
	    	    }
	    	    $('#datasettable').html(table)
	    	    console.log(i)
	    	    for(j=0;j<i;j++){
	    	    	if($('#triplestoredropdown_property_'+j).val().includes("http")){
		    	    	var url=$('#triplestoredropdown_property_'+j).val()+$("#coluri_"+j+"_input").val()
	    	    		$("#coluri_"+j+"_input").autocomplete({
		    	    	      source: function( request, response ) {
		    	    	        $.ajax( {
		    	    	          url: url,
		    	    	          dataType: "jsonp",
		    	    	          data: {
		    	    	            term: request.term
		    	    	          },
		    	    	          success: function( data ) {
		    	    	        	console.log(data)
		    	    	            response( data );
		    	    	          }
		    	    	        } );
		    	    	      },
		    	    	      minLength: 2,
		    	    	      select: function( event, ui ) {
		    	    	    	$("#coluri_"+j+"_input").val(ui.item.value)
		    	    	      }
		    	    	    } );
	    	    	}else{
	    	    		$("#coluri_"+j+"_input").autocomplete({
		    	    	      source: window[$('#triplestoredropdown_property_'+j).val()]["objproperties"],
		    	    	      minLength: 2,
		    	    	      select: function( event, ui ) {
		    	    	    	$("#coluri_"+j+"_input").val(ui.item.value)
		    	    	      }
		    	    	    } );
	    	    	}
	    	    	
	    	    	/*
    	    		$('#coluri_'+j+'_input').keyup(function(e) {
  	    			  console.log("OnKeyUp")
  	    			  queryString=$('#triplestoredropdown_property_'+$(this).prop('name')).val()+$(this).val()
  	    			  console.log(queryString)
  	    			  $.ajax({
							url: queryString,

							// The name of the callback parameter, as specified by the YQL service
							jsonp: "callback",

							// Tell jQuery we're expecting JSONP
							dataType: "jsonp",

							// Tell YQL what we want and that we want JSON
							data: {
  						//q: "select title,abstract,url from search.news where query=\"cat\"",
  						//format: "json"
							},

							// Work with the response
							success: function( result ) {
								console.log("Success!")
								console.log(result["search"][0]["label"])
								$('#'+qid).text(result["search"][0]["label"]+" ("+qid+")")   
							}
						});
  	    		    });*/
	    	    }
	    	    toggleAnalysis()
	       }
	    });
}

function convert() {
    var data = new FormData(); // das ist unser Daten-Objekt ...
    data.append('file', document.getElementById('files').files[0]); // ... an die wir unsere Datei anhngen
    $('#loading').show();
    $.ajax({
       url: 'rest/service/convert?namespace='+encodeURIComponent($('#namespace').val())+"&indid="+encodeURIComponent($('#indid').val())+"&classname="+encodeURIComponent($('#classname').val()), // Wohin soll die Datei geschickt werden?
       data: data,          // Das ist unser Datenobjekt.
       type: 'POST',         // HTTP-Methode, hier: POST
       processData: false,
       contentType: false,
       // und wenn alles erfolgreich verlaufen ist, schreibe eine Meldung
       // in das Response-Div
       success: function(data) { 
    	    $('#loading').hide();
    	   saveTextAsFile(data,".ttl","result");
       }
    });
 }
 
function toggleTripleStore() {
	  var x = document.getElementById("triplestoreimport");
	  if (x.style.display === "none") {
	    x.style.display = "block";
	  } else {
	    x.style.display = "none";
	  }
	}
function toggleAnalysis() {
	  var x = document.getElementById("metadata");
	  if (x.style.display === "none") {
	    x.style.display = "block";
	  } else {
	    x.style.display = "none";
	  }
	}
</script>
</head>

<body>
<div id="spinner">
  <img src="ajax-loader.gif" alt="Loading" id="loading" style="display: none"/>
</div>

	<h1>Upload your file for content analysis:</h1>

	<p id="metadata" style="display:none">
	<h4>Metadata</h4>
	Creator: <input id="creator" type="text"/><br/>
	Creation Time: <input id="creationtime" type="datetime"/><br/>
	Target Namespace: <input type="url" name="namespace" id="namespace"><br/>
 	Individual Attribute: <input type="text" name="indid" id="indid"><br/>
 	Class to assign (URI): <input type="text" name="classname" id="classname"><br/>
 	<input type="checkbox" id="importTripleStore" onChange="toggleTripleStore()">Import to a triple store
 	<p id="triplestoreimport" style="display:none">
 	  I want to import the file into the following triple store:<br/>
 	  <table>
	   <tr><td>TripleStore:</td><td><input type="text" name="triplestore" id="triplestore" value=""/></td></tr>
	   <tr><td>Graph:</td><td> <input type="text" name="triplestoregraph" id="triplestoregraph" value=""/></td></tr>
	   <tr><td>Username:</td><td> <input type="text" name="triplestoreuser" id="triplestoreuser" value=""/></td></tr>
 	   <tr><td>Password: </td><td><input type="text" name="triplestorepasswd" id="triplestorepasswd" value=""/></td></tr>
 	   </table>
 	</p>
	</p>
 	<table id="datasettable" width="100%" border="1">
 	</table>
	   <p>
		Select a file : <input type="file" name="file" id="files" size="45" /><br/>
		Fileformat: 
		<select id="fileformat"><option value="shp">Shapefile</option>
		<option value="geojson">GeoJSON</option></select>
	   </p>

	   <button id="uploadButton" onclick="analyzeFile()">Upload It</button>
 
</body>
</html>